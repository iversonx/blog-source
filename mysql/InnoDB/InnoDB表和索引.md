## 14.8 InnoDB表和索引

### 14.8.1 InnoDB表

#### 14.8.1.1 创建InnoDB表

```sql
CREATE TABLE t1 (a INT, b CHAR (20), PRIMARY KEY (a)) ENGINE=InnoDB;
```

- 在每个表的文件表空间创建表
  
  1. 当启用`innodb_file_per_table`时，会在每个表的单个文件表空间中隐式创建一个innoDB表。
  
  2. 对于每个表文件表空间中创建的表，MySQL默认会在数据库目录中创建.ibd表空间文件。

- 在InnoDB系统表空间创建表
  
  1. 当`innodb_file_per_table`被禁用时，在innodb系统表空间中隐式创建一个innodb表。
  
  2. 在InnoDB系统表空间中创建的表是在现有的ibdata文件中创建的，该文件驻留在MySQL数据目录中。

- 在通用表空间中创建表
  
  1. 要在通用表空间中创建表，请使用CREATE TABLE ... TABLESPACE语法。
  
  2. 在通用表空间中创建的表在现有的通用表空间.ibd文件中创建。

##### InnoDB表和.frm文件

MySQL在数据库目录中的.frm文件中存储表的数据字典信息。InnoDB还在系统表空间内的内部数据字典中对表信息进行编码。当MySQL删除表或数据库时，它会删除一个或多个.frm文件以及InnoDB数据字典中的相应条目。

##### InnoDB表和行格式

InnoDB表的默认行格式由innodb_default_row_format配置选项定义，其默认值为DYNAMIC。动态和压缩行格式允许您利用InnoDB特性，例如表压缩和长列值的高效页外存储。 要使用这些行格式，必须启用innodb_file_per_table，innodb_file_format必须设置为Barracuda。

或者可以使用`CREATE TABLE ... TABLESPACE`语法在通用表空间中创建InnoDB表。 通用表空间支持所有行格式。

##### InnoDB表和主键

始终为innoDB表创建主键，可以指定以下列为主键：

- 被重要的查询引用

- 永远不会为空

- 永远不会有重复的值

- 插入后很少改变值

如果没有明显的列用可以作为主键，就创建一个自增长的id作为主键。

##### 查看InnoDB表属性

使用`SHOW TABLE STATUS FROM 数据库名称 WHERE 条件`可以查看表属性。

```sql
SHOW TABLE STATUS FROM 数据库名称 WHERE 条件;
```

也可以使用`INFORMATION_SCHEMA.INNODB_SYS_TABLES`查询InnoDB表属性。

```sql
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES WHERE 条件
```

#### 14.8.1.2 InnoDB表的物理行结构

InnoDB表的物理行结构取决于创建表时指定的行格式。

##### Redundant行格式特点

REDUNDANT格式可用于保持与旧版MySQL的兼容性。

- 每个索引记录包含一个6字节的标头。标头用于将连续记录链接在一起，也用于行级锁定。

- 聚簇索引中的记录包含所有用户定义列的字段。此外，还有一个6字节的事务ID字段和一个7字节的滚动指针字段。

- 如果没有定义主键，则每个聚簇索引还包含一个6字节的row id字段。

- 每个次索引包含对聚簇索引定义的所有主键字段，这些字段不在次索引中。

- 记录包含指向记录的每个字段的指针。如果记录中字段的总长度小于128字节，则指针是一个字节;否则，两个字节。这些指针的数组称为记录目录。这些指针指向的区域称为记录的数据部分。

- 以固定长度格式存储固定长度的字符列。

- InnoDB将长度大于或等于768字节的固定长度字段编码为可变长度字段，可以在页外存储。

- NULL值在记录目录中保留一个或两个字节。SQL NULL值在记录目录中保留一个或两个字节。 除此之外，如果存储在可变长度列中，则SQL NULL值在记录的数据部分中保留零个字节。 在固定长度的列中，它在记录的数据部分中保留列的固定长度。 为NULL值保留固定空间可以将列的更新从NULL更新为非NULL值，而不会导致索引页碎片化。

##### COMPACT行格式特点

与REDUNDANT格式相比，COMPACT行格式减少了约20%的行存储空间，同时增加了某些操作的CPU使用。如果您的工作负载是受缓存命中率和磁盘速度限制的典型工作负载，则COMPACT格式可能会更快。 如果工作负载是受CPU速度限制的罕见情况，则紧凑格式可能会更慢。

- 每个索引记录包含一个5字节的头，可以在可变长度头之前。标头用于将连续记录链接在一起，也用于行级锁定。
- 如果没有为表定义主键，则每个聚簇索引记录还包含一个6字节的行ID字段。

#### 14.8.1.3 移动或复制InnoDB表

移动或复制InnoDB表的技术包括：

- 可传输的表空间

- MySQL企业备份

- 复制数据文件（冷备份方法）

- 导出和导入（mysqldump）

##### 可传输的表空间(Transportable Tablespaces)

可传输表空间功能使用`FLUSH TABLES ... FOR EXPORT`来准备InnoDB表，以便从一个服务器实例复制到另一个服务器实例。要使用这个功能，必须在innodb_file_per_table设置为ON的情况下创建InnoDB表，使每个表有自己的空间。

#### 14.8.1.4 将表从MyISAM转换为InnoDB

#### 14.8.1.5 InnoDB中的AUTO_INCREMENT处理

#### 14.8.1.6 InnoDB和FOREIGN KEY约束

#### 14.8.1.7 InnoDB表的限制

### 14.8.2 InnoDB索引

#### 14.8.2.1 聚簇索引和二级索引

##### 聚簇索引

每个InnoDB表都一个称为聚簇索引的特殊索引，存储了行的数据。

1. 当在表上定义PRIMARY KEY时，InnoDB将其用作聚簇索引。

2. 当没有定义PRIMARY KEY时，MySQL会找到第一个UNIQUE索引，其中所有键列都是NOT NULL，InnoDB将其用作聚簇索引。

3. 如果表没有PRIMARY KEY和UNIQUE索引，InnoDB会在包含row id的合成列上生成一个名为gen_clust_index的隐藏聚簇索引。

##### 聚簇索引如何加快查询速度

通过聚簇索引来寻找一行数据时非常快的，这是因为行数据和索引在同一页。如果表特别大，聚簇索引的这种构造能节省磁盘IO资源。

##### 次索引与聚簇索引的关系

除了聚簇索引之外的所有索引都称为次索引。在 InnoDB中，次索引的每条记录都包含该行的主键列以及次索引指定的列。InnoDB使用此主键值来搜索聚簇索引中的行。

#### 14.8.2.2  InnoDB索引的物理结构

除了空间索引外，InnoDB索引使用B-tree数据结构。索引页默认大小为16KB。

当新记录插入到InnoDB聚簇索引中，InnoDB将尝试保留页的1/16空间，以便将来插入和更新索引记录。如果按顺序插入索引记录，则生成的索引页大约为15/16。如果随机插入记录，则生成索引页大约为1/2和15/16 。

InnoDB在创建或重建B树索引时执行批量加载。这种索引创建方法被称为排序索引构建。`innodb_fill_factor`配置选项定义在排序索引构建期间填充的每个B-tree页上的空间百分比，剩余空间保留用于将来索引增长。

#### 14.8.2.3 排序索引构建

在创建或重建索引时InnoDB执行批量加载，而不是一次插入一个索引记录。这种索引创建方法称为排序索引构建。

索引构建有3个阶段。第一阶段，扫描聚簇索引，生成索引项并将其添加到排序缓冲区。当排序缓冲区满时，索引项将被排序写入临时中间文件。此过程也称为“运行”。

在第二阶段，将一个或多个运行写入临时中间文件，对文件中的所有条目执行合并排序。最后一个阶段，已排序的条目将插入到B tree中。

在引入排序索引构建之前，mysql通过一次插入一条记录来构建次索引。这种方法使用b-tree游标查找插入位置，然后使用乐观插入将条目插入b-tree页；如果由于页已满而插入失败，则执行悲观插入，这涉及打开b-tree游标并根据需要拆分和合并b-tree节点查找条目空间。这种自上而下方法的缺点是搜索插入位置的成本以及b-tree的分裂和合并。

排序索引构建使用“自下而上”方法构建索引。这种方法对最右侧叶页的引用保存在B-Tree的所有级别。在必要的b-tree深度分配最右边的叶页，并根据其排序顺序插入条目。

此过程将继续，直到插入所有条目，这可能导致插入到根级别。 分配兄弟页面时，将释放对先前固定的叶子页面的引用，并且新分配的叶子页面将成为最右侧的叶子页面和新的默认插入位置。

要为将来的索引增长留出空间，可以使用`innodb_fill_factor`配置选项来保留B-Tree页面空间的百分比。例如，将innodb_fill_factor设置为80可在排序索引构建期间保留B树页面中20％的空间。此设置适用于B树叶和非叶页。 它不适用于用于TEXT或BLOB条目的外部页面。 保留的空间量可能与配置的不完全相同，因为innodb_fill_factor值被解释为提示而不是硬限制。

#### 14.8.2.4

InnoDB FULLTEXT索引
