---
title: 类加载过程
date: 2019-06-28
categories: jvm
tags: 学习笔记
description: 
---

类加载过程由加载，链接，初始化这3个阶段组成：

- 加载是指根据特定名称查找类或接口的二进制形式，并根据二进制形式来创建类和接口的过程。

- 链接是指获取类或接口的二进制形式，并将其与JVM的运行时状态结合起来，使得类或接口可以被运行的过程。

- 初始化是指为常量字段赋值，以及执行`<clinit>`方法的过程。

## 加载

常见的一种加载是：获取由Java编译器对源代码编译后生成的class字节码文件，从字节码文件构建表示该类或接口的Class对象。

在加载阶段中，需要完成3件事：

- 通过类的全限定名来获取定义此类的二进制字节流

- 将字节流所代表的静态存储结构转化为方法区的运行时数据结构

- 在内存中生成一个代表类的Class对象，作为这个类的各种数据访问入口。

类和接口的加载使用类加载器来完成，但对于数组类，因为数组类没有对应的字节码文件，所以则是由JVM直接生成的。

数组类创建需要遵循以下规则：

- 如果数组的组件类型(去掉纬度的类型)是引用类型，那就去加载这个组件类型。

- 如果数组的组件类型不是引用类型，JVM会把数组标记与引导类加载器相关联。

加载阶段完成后，二进制字节流就按照JVM所需的格式存储在方法之中，然后实例化一个java.lang.Class类的对象。

## 链接

在类或接口被链接之前，类或借必须已经被成功地加载。在链接阶段，会经历二进制表示的验证，接口或类的准备以及符号引用的解析。

### 验证

验证是链接阶段的第一步，其目的是为了确保Class文件的字节流中的信息是否符合当前虚拟机的要求。

虚拟机如果不对输入的字节流进行验证，而直接载入的话，一旦载入恶意代码的攻击，可能会导致系统崩溃。因此JVM在准备加载Class文件时，首先对Class文件进行格式检查，确保class文件的格式符合要求。格式检查包括(但不限于)以下内容：

- 前四个字节必须是正确的magin number(0xCAFEBABE)

- class文件内容是否完整

- 主次版本号是否在当前虚拟机处理范围之内

- 常量池是否符合各项约束

- 常量池中的所有字段引用及方法引用，都必须具备有效的名称、有效的类及有效的描述符(符号引用)

文件格式检查不会验证类的元数据信息是否符合Java语言规范，也不确保符号引用会指向真实的类。

在格式检查通过并完成加载阶段后，JVM开始对字节码进行语义分析，以保证字节码描述的信息符合Java语言规范的要求，例如：

- 一个类是否有父类(除Object类外，所有的类都应该有父类)；

- 类是否继承了被final修饰的类；

- 如果不是抽象类，是否实现了其父类或接口要求实现的所有方法。

- ......

在对元数据信息做完校验后，这个阶段将对类的方法体进行校验分析，确保类的方法在运行时不会做出危害虚拟机安全的事件，例如：

- 保证跳转指令不会跳转到方法体以外的字节码指令上。

- 保证方法中的类型转换是有效的

- ......

在JVM将符号引用转化为直接引用时，会对符号引用进行验证。符号引用验证可以看做是对类自身以外的信息进行匹配校验，例如：

- 符号引用通过字符串描述的全限定名是否能找到对应的类。

- 符号引用中的类，字段，方法是否可被当前类访问，即访问权限(private, protected, public, default)

- ......

符号引用验证的目的是确保解析动作能正常执行。

对于类加载机制，验证是非常重要，但不是一定必需的阶段。如果所运行的代码(自己编写的及第三方包中代码)都已经被反复使用和验证过，就可以在实施阶段考虑使用`-Xverify:none`参数来关闭大部分的类验证，以缩短虚拟机类加载时间。

### 准备



### 解析

## 初始化
