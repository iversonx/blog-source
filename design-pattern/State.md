---
title: 状态模式(State)
date: 2018-10-26
categories: 设计模式
tags: 学习笔记
description: 
---
#### 一、什么是状态模式
##### 1. 定义
允许一个对象在其内部状态改变时改变它的行为。对象看起来似乎修改了它的类。

解释：由于状态是在运行期被改变的，因此行为也会在运行期根据状态的改变而改变，看起来，同一个对象，在不同的运行时刻，行为是不一样的，就像类被修改了一样。

##### 2. 使用状态模式的思路
1. 首先把状态和状态对应的行为从原来的代码中分离出来，把每个状态所对应的功能处理封装在一个独立的类里面，这样选择不同处理时，其实就是选择不同的状态的处理类。
2. 为了统一操作不同的状态类，定义一个接口来约束它们，这样外部就可以面向统一的状态接口编程，无须关心具体的实现类。

##### 3. 结构和说明
[结构图]

- Context：环境，也叫上下文，通常用来定义客户感兴趣的接口，同时维护一个来具体处理当前状态的实例对象。
- State：状态接口，用来封装与上下文的一个特定状态所对应的行为
- ConcreteState：具体实现状态处理的类，每个类实现一个跟上下文相关的状态的具体处理。

##### 4. 示例代码
```java
public interface State {
	public void handle(String parameter);
}

public class ConcreteState implements State {
	public void handle(String parameter) {
		//具体实现处理
	}
}

/**
 * 定义客户感兴趣的接口,通常维护一个State类型的对象实例
 */
public class Context {
	
	private State state;

	public void setState(State state) {
		this.state = state;
	}

	public void request(String parameter) {
		state.handle(parameter);
	}
}
```

##### 5. 状态和行为
对象的状态通常指对象实例的属性值；行为通常指对象的功能，大多对应对象的方法。

状态模式的功能就是分离状态的行为，通过维护状态的变化，来调用不同状态对应的不同功能。

##### 6. 行为的平行性和平等性
平行性：各个状态的行为所处的层次是一样的，相互独立的、没有关联的，是根据不同的状态来决定到底走平行线的哪一条。行为不同，对应的实现也不同，相互之间是不可替换的。

平等性强调是可替换的，大家是同一个行为的不同描述或实现，因此在同一个行为发生时，可以根据条件挑选任意一个实现来进行相应的处理。

##### 7. 上下文和状态处理对象
上下文：持有状态的对象，自身不处理跟状态相关的行为，而是把处理状态的功能委托给了状态对应的状态处理类来处理。

状态处理对象：处理状态的对象，通常需要获取上下文自身的数据，必要时会回调上下文的方法，因此将上下文当作一个参数传递给具体的状态类。

客户端一般只和上下文交互。客户端用状态对象来装配一个上下文，一旦配置完，就不再需要状态对象了。客户端不负责在运行期间状态的维护。

##### 8. 创建和销毁状态对象的时机
- 当需要使用状态对象时创建，使用完后销毁。
- 提前创建状态对象，且始终不销毁。
- 采用延迟加载和缓存合用，当第一次需要使用状态对象时创建，使用完后不销毁，而是缓存起来，等待下一次使用。

##### 9. 状态的维护和转换控制
维护指的是维护状态的数据，给状态设置不同的状态值；而状态的转换是根据状态的变化来选择不同的状态处理对象。

通常有两个地方可以进行状态的维护和转换控制
1. 在上下文中。因为状态本身通常被实现为上下文对象的状态，因此可以在上下文中进行状态维护和转换。
2. 在状态处理类中。当每个状态处理对象处理完自身状态所对应的功能后，可以根据需要指定后继状态，以便让应用能正确处理后续请求。

###### 如何选择这两种方式
- 如果状态转换的规则是一定的，一般不需要进行规则扩展，那么就适合在上下文统一进行状态的维护。
- 如果状态的转换取决于前一个状态动态处理的结果，或者是依赖于外部数据，为了增加灵活性，一般是在状态处理类中进行状态的维护。

#### 二、状态模式的优缺点
##### 优点
- 更好地分离状态和行为：通过设置状态接口，把状态和状态对应的行为分离开，把所有与一个特定的状态相关的行为都放入一个对象中，使得应用在控制时，只需关心状态的切换，而不用关心这个状态对应的真正处理。

- 更好的扩展性：引入状态接口后，使得扩展新的状态变得非常容易，只需新增加一个实现状态处理的公共接口的实现类，然后在进行状态维护的地方，设置状态变化到这个新状态即可。

- 简化应用逻辑控制：
- 显式化进行状态转换：

##### 缺点
- 一个状态对应一个状态处理类，会使得程序引入太多的状态类，这样程序变得杂乱。

#### 三、何时选用状态模式

1. 如果一个对象的行为取决于它的状态，而且它必须在运行时刻根据状态来改变它的行为，可以用状态模式来把状态和行为分离开。
2. 如果一个操作中含有庞大的多分支语句，而且这些分支依赖于该对象的状态，可以使用状态模式，把各个分支的处理分散包装到单独的处理类中，这样，这些分支对应的对象就可以不依赖于其他对象而独立变化了。

